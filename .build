#!/bin/bash

source .packages.rc

if [[ "$1" == "one" ]]
then
	make -s -j4 -C ${2} && sudo make -s -C ${2} install
	if [[ $? != 0 ]]
	then
		exit -1
	fi
    exit 0
fi

distro=$(lsb_release -c -s)
goahead="false"
for package in ${projects[@]}
do
    title="Processing '${package}'"
    underlines=$(printf %s "${title}" | tr -c '-' '[-*]')
    echo
    echo ${title}
    echo ${underlines}
    
    case "$1" in
	all)
	    make -s -j4 -C ${package} && sudo make -s -C ${package} install
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
	    ;;
    from)
        if [[ "$2" == "${package}" ]]
        then
            goahead="yes"
        fi
        if [[ "${goahead}" == "yes" ]]
        then
	        make -s -j4 -C ${package} && sudo make -s -C ${package} install
	        if [[ $? != 0 ]]
	        then
		        exit -1
	        fi
        fi
        ;;
	single)
	    make -s -C ${package} && sudo make  -s -C ${package} install
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
	    ;;
	clean)
	    make -s -C ${package} clean
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
	    ;;
	install)
	    sudo make -s -C ${package} install
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
	    ;;
	uninstall)
	    sudo make -s -C ${package} uninstall
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
	    ;;
	distcheck)
	    rm -rfv ${package}/*.tar.gz
	    sudo make -s -C ${package} -j4 distcheck && sudo make -s -C ${package} install
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
	    ;;
	distclean)
	    rm -rfv ${package}/*.tar.gz
	    sudo make -s -C ${package} distclean
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
	    ;;
	config)
        pushd ${package} > /dev/null
	    autoreconf -vfi && ./configure  --prefix=/usr --sysconf=/etc --libdir=/usr/lib --libexecdir=/usr/lib "CXXFLAGS=-O3 -Wall -fno-stack-protector"
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
        popd > /dev/null
	    ;;
	asan)
        pushd ${package} > /dev/null
	    autoreconf -vfi && ./configure  --prefix=/usr --sysconf=/etc --libdir=/usr/lib --libexecdir=/usr/lib "CXXFLAGS=-fsanitize=address -fno-omit-frame-pointer -ggdb3 -Wall -fno-stack-protector" LDFLAGS="-lasan"
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
        popd > /dev/null
	    ;;
	debug)
        pushd ${package} > /dev/null
	    autoreconf -vfi && ./configure  --prefix=/usr --sysconf=/etc --libdir=/usr/lib --libexecdir=/usr/lib "CXXFLAGS=-O0 -ggdb3 -Wall"
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
        popd > /dev/null
	    ;;
	package)
        pushd ${package} > /dev/null
	    ./make_deb
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
        popd > /dev/null
	    ;;
    esac
done
