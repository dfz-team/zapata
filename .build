#!/bin/bash

source .packages.rc

if [[ "$1" == "one" ]]
then
	make -s -j4 -C ${2}/build && sudo make -s -C ${2}/build install
	if [[ $? != 0 ]]
	then
		exit -1
	fi
    exit 0
fi

distro=$(lsb_release -c -s)
goahead="false"
for package in ${projects[@]}
do
    title="Processing '${package}'"
    underlines=$(printf %s "${title}" | tr -c '-' '[-*]')
    echo
    echo ${title}
    echo ${underlines}
    
    case "$1" in
	all)
	    make -s -j4 -C ${package}/build && sudo make -s -C ${package}/build install
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
	    ;;
    from)
        if [[ "$2" == "${package}" ]]
        then
            goahead="yes"
        fi
        if [[ "${goahead}" == "yes" ]]
        then
	        make -s -j4 -C ${package}/build && sudo make -s -C ${package}/build install
	        if [[ $? != 0 ]]
	        then
		        exit -1
	        fi
        fi
        ;;
	single)
	    make -s -C ${package}/build && sudo make -s -C ${package}/build install
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
	    ;;
	clean)
	    make -s -C ${package}/build clean
	    ;;
	install)
	    sudo make -s -C ${package}/build install
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
	    ;;
	uninstall)
	    sudo make -s -C ${package}/build uninstall
	    ;;
	distcheck)
	    rm -rfv ${package}/*.tar.gz
	    sudo make -s -C ${package}/build -j4 distcheck && sudo make -s -C ${package}/build install
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
	    ;;
	distclean)
	    rm -rfv ${package}/*.tar.gz
	    sudo make -s -C ${package}/build distclean
	    ;;
	config)
        pushd ${package} > /dev/null
	    rm -rf build && autoreconf -vfi && mkdir build && cd build && ../configure  --prefix=/usr --sysconf=/etc --libdir=/usr/lib --libexecdir=/usr/lib "CXXFLAGS=-O3 -Wall -fno-stack-protector"
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
        popd > /dev/null
	    ;;
	debug)
        pushd ${package} > /dev/null
	    rm -rf build && autoreconf -vfi && mkdir build && cd build && ../configure  --prefix=/usr --sysconf=/etc --libdir=/usr/lib --libexecdir=/usr/lib "CXXFLAGS=-O0 -ggdb3 -Wall"
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
        popd > /dev/null
	    ;;
	package)
        pushd ${package} > /dev/null
	    ./make_deb
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
        popd > /dev/null
	    ;;
    format)
        pushd ${package} > /dev/null
        change_list=($(find . -name "*.cpp" -o -name "*.h"))
        for f in ${change_list[@]}
        do
            echo "checking '${f}'"
            dos2unix ${f}
            clang-format -i --style=file ${f}
	        if [[ $? != 0 ]]
	        then
		        exit -1
	        fi
        done
        ;;
    tidy)
        pushd ${package} > /dev/null
        # clang-tidy --format-style=file --config= $(find . -name "*.cpp")
        #  --fix-errors --fix
        # '-*,cppcoreguidelines*,clang-analyzer-cplusplus*,modernize*,bugprone*,-cppcoreguidelines-pro-*,-cppcoreguidelines-avoid-magic-numbers,-cppcoreguidelines-init-variables'
	    if [[ $? != 0 ]]
	    then
		    exit -1
	    fi
        popd > /dev/null
        ;;
    esac
done
