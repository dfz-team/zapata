#!/bin/zsh

source .packages.rc

distro=$(lsb_release -c -s)
for package in ${projects[@]}
do
    pushd $package
    echo && pwd

    case "$1" in
	j4)
	    make -j4 && sudo make install
	    if [[ $? != 0 ]]
	    then
		exit -1
	    fi
	    ;;
	all)
	    make && sudo make install
	    if [[ $? != 0 ]]
	    then
		exit -1
	    fi
	    ;;
	clean)
	    make clean
	    if [[ $? != 0 ]]
	    then
		exit -1
	    fi
	    ;;
	install)
	    sudo make install
	    if [[ $? != 0 ]]
	    then
		exit -1
	    fi
	    ;;
	uninstall)
	    sudo make uninstall
	    if [[ $? != 0 ]]
	    then
		exit -1
	    fi
	    ;;
	distcheck)
	    sudo make distcheck
	    if [[ $? != 0 ]]
	    then
		exit -1
	    fi
	    ;;
	distclean)
	    rm -rfv *.tar.gz
	    sudo make distclean
	    if [[ $? != 0 ]]
	    then
		exit -1
	    fi
	    ;;
	config)
	    autoreconf -vfi && ./configure --prefix=/usr --sysconf=/etc "CXXFLAGS=-O3 -Wall"
	    if [[ $? != 0 ]]
	    then
		exit -1
	    fi
	    ;;
	debug)
	    autoreconf -vfi && ./configure --prefix=/usr --sysconf=/etc "CXXFLAGS=-O0 -ggdb3 -Wall"
	    if [[ $? != 0 ]]
	    then
		exit -1
	    fi
	    ;;
	package)
	    rm -rfv *.deb
	    mkdir -p upstream
	    rm -rfv upstream/*
	    for f in *.tar.gz
	    do
		fullname=${f%.tar.gz}
		prefix=${fullname##*/}
		revision=${prefix##*-}
		no_revision_prefix=${prefix%-*}
		version=${no_revision_prefix##*-}
		no_version_prefix=${no_revision_prefix%-*}
		orig=upstream/$no_version_prefix\_$version.orig.tar.gz
		echo "processing $orig"
		cp -rf $f $orig
		pushd upstream/
		tar xvzf $no_version_prefix\_$version.orig.tar.gz
		pushd $prefix/
		debuild -us -uc
		if [[ $? != 0 ]]
		then
		    exit -1
		fi
		sudo mv ../$no_version_prefix\_$version-$revision\_amd64.deb ../../
		popd
		popd
	    done
	    rm -rfv upstream/
	    ;;
    esac
    popd
done
